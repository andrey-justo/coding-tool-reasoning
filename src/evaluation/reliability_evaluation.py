from bert_score import BERTScorer


class ReliabilityEvaluationTool:
    """
    Tool for evaluating code changes based on reliability problems using BERTScore.
    """

    def __init__(self):
        self.name = "ReliabilityEvaluationTool"
        self.description = "Tool for evaluating code changes based on reliability problems using BERTScore."
        self.scorer = BERTScorer(model_type="bert-base-uncased", lang="en")

    def extract_csharp_code(self, text: str) -> str:
        import re

        match = re.search(r"```csharp(.*?)```", text, re.DOTALL)
        if match:
            return match.group(1).strip()
        return text  # Return original text if no code block found

    def extract_code_from_agent_response(self, response) -> str:
        generated_code = ""
        for message in response.messages:
            for m in message.contents:
                generated_code += m.text + "\n"
        return self.extract_csharp_code(generated_code)

    def evaluate(self, generated_code: str, reference_code: str):
        """
        Evaluate the generated code against the reference code using BERTScore.
        Args:
                generated_code (str): The code generated by the tool.
                reference_code (str): The reference or target code for comparison.
        Returns:
                dict: A dictionary with precision, recall, and F1 scores.
        """
        P, R, F1 = self.scorer.score([generated_code], [reference_code])
        return {"precision": P[0].item(), "recall": R[0].item(), "f1": F1[0].item()}
